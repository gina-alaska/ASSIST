/*
# Place all the behaviors and hooks related to the matching controller here.
# All this logic will automatically be available in application.js.
*/


$(document).ready(function() {
  var $obsForm = $('#observation_form');
  var $photoForm = $('#photo_form');
  $obsForm.tabs({
    show: function(event, ui) {
      $(ui.panel).find('.topography').chosen({
        width: '98%'
      }).change( handleTopographies ).removeClass("topography");


      $(ui.panel).find('.combobox:visible').chosen({
        width: '98%'
      });
      $(ui.panel).find('.users:visible').chosen({
        no_results_text: "That user was not found.",
        width: '98%'
      });
    },
    select: function(event,ui) {
      var form = $(".ui-tabs-panel form.autosave.dirty:visible");
      console.log("TABS", form.length);
      if(form.length !== 0 ) {
        console.log( "Fooo!");
        event.preventDefault();
        saveFormAndChangeTab(form.first(), ui);
      }
    }

  });

  $("#next_button").click(function(event) {
    event.preventDefault();

    var panel = $("#observation_form");
    var currentTab = $(panel).tabs('option','selected');
    $(panel).tabs('option', 'selected', currentTab + 1);

  });


  $("#nav_buttons").buttonset();
  $(".photo_locations").buttonset();
  $(".radioset").buttonset();
  $("#adduser").button({
    icons: {
      primary: 'ui-icon-plusthick'
    }
  });

  $("#observation_date").datepicker({
    dateFormat: "yy.mm.dd",
    constrainInput: false
  });

  $("form.autosave").change( function() {
    $(this).addClass("dirty");
    $("#save_button").addClass("dirty");
    $("#save_button").button("enable");
  });


  $("#save_button").click( function(event) {
    var form = $(".ui-tabs-panel form.autosave.dirty:visible");
    $.each(form, function( index, f ) {
      $.rails.handleRemote( $(f) );
    });
    event.preventDefault();
  });



  $("form.notify").bind("ajax:beforeSend", function(e) {
    $(".field_with_errors").removeClass("field_with_errors");
    $.growlUI("", "Saving");
  });
  $("form.notify").bind("ajax:error", function(evt, xhr, status, error) {
    var response = $.parseJSON(xhr.responseText);
    var msg = response.flash;

    $.each(response.errors, function( key, values) {
      $("."+key).addClass("field_with_errors");
    });
    $.growlUI("Errors", response.flash.join("<br />"));
  });
  $("form.notify").bind("ajax:success", function(evt, data, status, xhr) {
    $.growlUI("","Save Successful");
    $("form.dirty:visible").removeClass("dirty");
    $("#save_button").removeClass("dirty");
    $("#save_button").button("disable");
  });

  $photoForm.fileupload({
    dataType: 'json',
    url: $photoForm.attr('action'),
    add: function(e, data) {
      $(this).block({
        message: "Please Wait..."
      });
      data.submit();
    },
    done: appendPhoto,
    error: uploadPhotoError
  });

 $(document).delegate('.delete_photo form input[type="submit"]', "click", function() {

   $(this).parents(".attached_photo").block({
     message: "Deleting"
   });

   return true;
 });
  $(document).delegate(".delete_photo form", "ajax:success", removePhoto);
  $(document).delegate(".photo_locations input", "click", updatePhotoLocation)
});


function appendPhoto(e, data) {
  var r = data.result;
  var url = "/observations/" + r.observation_id + "/photos/" + r.id;
  var photo = $.get( url, function(data) {
      $("#attached_photos").append(data);
      $(".photo_locations").buttonset();
  });
  $("#photo_form").unblock();
}



function uploadPhotoError(jqXHR, textStatus, error) {

  var msg = $.parseJSON(jqXHR.responseText);
  $.each(msg, function(index, value) {
    $.growlUI(value);
  });
  $("#photo_form").unblock();
}

function removePhoto() {
  $(this).parents(".attached_photo").remove();
  $.growlUI('', "Photo deleted");
}

function updatePhotoLocation() {
  var form = $(this).parents('form');
  var url =$(form).attr('action');
  $.post( url, $(form).serialize(), function() {
    $.growlUI(('', 'Saved'))
  });

}

function saveFormAndChangeTab( form, ui ) {

  $(form).block({message:null});
  $.ajax({
    url: $(form).attr("action"),
    type: 'PUT',
    data: $(form).serialize(),
    beforeSend: function(xhr, settings) {
      return $.rails.fire( form, "ajax:beforeSend",[xhr,settings]);
    },
    success: function(data, status, xhr) {
      $(form).unblock();
      $(form).removeClass("dirty");
      console.log(ui);
      $("#observation_form").tabs('option', 'selected', ui.index);
      form.trigger("ajax:success", [data,status,xhr]);
    }
  });
}