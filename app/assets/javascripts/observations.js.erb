/*
# Place all the behaviors and hooks related to the matching controller here.
# All this logic will automatically be available in application.js.
*/


$(document).ready(function() {
  var $obsForm = $('#observation_form');
  var $photoForm = $('#photo_form');
  $obsForm.tabs({
    show: function(event, ui) {
      $(ui.panel).find('.topography').chosen({
        width: '98%'
      }).change( handleTopographies ).removeClass("topography");


      $(ui.panel).find('.combobox:visible').chosen({
        width: '98%'
      });
      $(ui.panel).find('.users:visible').chosen({
        no_results_text: "That user was not found.",
        width: '98%'
      });
    },
    select: function(event,ui) {
      var form = $(".ui-tabs-panel form.autosave.dirty:visible");
      console.log("TABS", form.length);
      if(form.length !== 0 ) {
        console.log( "Fooo!");
        event.preventDefault();
        saveFormAndChangeTab(form.first(), ui);
      }
    }

  });

  $("#next_button").click(function(event) {
    event.preventDefault();

    var panel = $("#observation_form");
    var currentTab = $(panel).tabs('option','selected');
    $(panel).tabs('option', 'selected', currentTab + 1);

  });


  $("#nav_buttons").buttonset();
  $(".photo_locations").buttonset();
  $(".radioset").buttonset();
  $("#adduser").button({
    icons: {
      primary: 'ui-icon-plusthick'
    }
  });

  $("#observation_date").datepicker({
    dateFormat: "yy.mm.dd",
    constrainInput: false
  });

  $("form.autosave").change( function() {
    $(this).addClass("dirty");
    $("#save_button").addClass("dirty");
    $("#save_button").button("enable");
  });


  $("#save_button").click( function(event) {
    var form = $(".ui-tabs-panel form.autosave.dirty:visible");
    $.each(form, function( index, f ) {
      $.rails.handleRemote( $(f) );
    });
    event.preventDefault();
  });



  $("form.notify").bind("ajax:beforeSend", function(e) {
    $(".field_with_errors").removeClass("field_with_errors");
    $.growlUI("", "Saving");
  });
  $("form.notify").bind("ajax:error", function(evt, xhr, status, error) {
    var response = $.parseJSON(xhr.responseText);
    var msg = response.flash;

    $.each(response.errors, function( key, values) {
      $("."+key).addClass("field_with_errors");
    });
    $.growlUI("Errors", response.flash.join("<br />"));
  });
  $("form.notify").bind("ajax:success", function(evt, data, status, xhr) {
    $.growlUI("","Save Successful");
    $("form.dirty:visible").removeClass("dirty");
    $("#save_button").removeClass("dirty");
    $("#save_button").button("disable");
  });

  $photoForm.fileupload({
    dataType: 'json',
    url: $photoForm.attr('action'),
    add: function(e, data) {
      $(this).block({
        message: "Please Wait..."
      });
      data.submit();
    },
    done: appendPhoto,
    error: uploadPhotoError
  });

 $(document).delegate('.delete_photo form input[type="submit"]', "click", function() {

   $(this).parents(".attached_photo").block({
     message: "Deleting"
   });

   return true;
 });
  $(document).delegate(".delete_photo form", "ajax:success", removePhoto);
  $(document).delegate(".photo_locations input", "click", updatePhotoLocation);

  $(".coord").change(  parseCoord )
});


function appendPhoto(e, data) {
  var r = data.result;
  var url = "/observations/" + r.observation_id + "/photos/" + r.id;
  var photo = $.get( url, function(data) {
      $("#attached_photos").append(data);
      $(".photo_locations").buttonset();
  });
  $("#photo_form").unblock();
}



function uploadPhotoError(jqXHR, textStatus, error) {

  var msg = $.parseJSON(jqXHR.responseText);
  $.each(msg, function(index, value) {
    $.growlUI(value);
  });
  $("#photo_form").unblock();
}

function removePhoto() {
  $(this).parents(".attached_photo").remove();
  $.growlUI('', "Photo deleted");
}

function updatePhotoLocation() {
  var form = $(this).parents('form');
  var url =$(form).attr('action');
  $.post( url, $(form).serialize(), function() {
    $.growlUI(('', 'Saved'))
  });

}

function saveFormAndChangeTab( form, ui ) {

  $(form).block({message:null});
  $.ajax({
    url: $(form).attr("action"),
    type: 'PUT',
    data: $(form).serialize(),
    beforeSend: function(xhr, settings) {
      return $.rails.fire( form, "ajax:beforeSend",[xhr,settings]);
    },
    success: function(data, status, xhr) {
      $(form).removeClass("dirty");
      console.log(ui);
      $("#observation_form").tabs('option', 'selected', ui.index);
      form.trigger("ajax:success", [data,status,xhr]);
    },
    complete: function(xhr, status) {
      form.trigger("ajax:complete", [xhr,status]);
      $(form).unblock();
    },
    error: function(xhr, status, error) {
      form.trigger("ajax:error", [xhr,status,error]);
    }
  });
}

function parseCoord( evt ) {
  var value = $(evt.target).val();
  this.toDD = function( v) {
    var c = v.split(" ")
    var deg = parseFloat(c[0]);
    var ms = c[1].split(".");
    var min = parseInt(ms[0]);
    var sec = ms.length > 1 ? parseInt(ms[1]) : 0;
    var dec = (min * 60 + sec) / 3600.0;
    var dd = deg > 0 ? deg + dec : deg - dec;
    return "DD: " + dd.toFixed(4);
  };

  this.toDMS = function(v) {
    var c = parseFloat(v);
    var deg = c < 0 ? Math.ceil(c) : Math.floor(c);
    var ms = Math.abs( c - deg )  * 60.0;
    var min = Math.floor( ms );
    var sec = (ms % 1 ) * 60.0;
    return "DMS: " + deg + " " + (min + Math.round(sec) / 100.0 );
  };
  var altText = "";
  if( value.match(/^(\+|-)?[0-9]{1,3}\s[0-9]{1,2}(\.[0-9]{1,2})?(\s?[NSEW])?$/)) {
    altText = this.toDD(value)
  } else if ( value.match(/^(\+|-)?[0-9]{1,3}\.[0-9]*(\s?[EW])?$/)) {
    altText = this.toDMS(value)
  }

  $(evt.target).siblings(".infotext:last").html(altText);

}